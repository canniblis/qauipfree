<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QauipFree Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map {
      width: 100vw;
      height: 100vh;
      min-height: 100vh;
      background: #f0f0f0; /* Фон для диагностики */
      box-sizing: border-box;
    }
    .warning-marker {
      width: 0;
      height: 0;
      border-left: 10px solid transparent;
      border-right: 10px solid transparent;
      border-bottom: 20px solid red;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Вставь свой MapBox токен здесь
    mapboxgl.accessToken = 'pk.eyJ1IjoicWF1aXBmcmVlIiwiYSI6ImNtYTN6YTBrbTAxOXYycnM4ZjE4ZG9sejIifQ.UxK3klpjrLBMMUW7FwG24g';

    // Проверка токена
    if (!mapboxgl.accessToken || mapboxgl.accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
      console.error('Ошибка: Вставьте валидный MapBox токен');
      alert('Карта не загрузилась: отсутствует токен MapBox');
      throw new Error('Неверный токен');
    }
    console.log('Токен:', mapboxgl.accessToken.slice(0, 10) + '...');

    // Проверка WebGL
    if (!mapboxgl.supported()) {
      console.error('Ошибка: WebGL не поддерживается');
      alert('Ваш браузер не поддерживает WebGL. Попробуйте другой браузер.');
      throw new Error('WebGL не поддерживается');
    }
    console.log('WebGL поддерживается');

    // Проверка ресурсов
    console.log('Ресурсы:');
    console.log('JS:', 'https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js');
    console.log('CSS:', 'https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css');

    // Проверка контейнера
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
      console.error('Ошибка: Контейнер #map не найден');
      alert('Ошибка: Контейнер карты не найден');
      throw new Error('Контейнер #map отсутствует');
    }
    console.log('Контейнер #map, размеры:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);

    // Город и координаты
    const urlParams = new URLSearchParams(window.location.search);
    const city = urlParams.get('city') || 'almaty';
    const cityData = {
      'almaty': { center: [76.8897, 43.2389], zoom: 12 },
      'almaty_region': { center: [77.5000, 43.5000], zoom: 8 },
      'astana': { center: [71.4459, 51.1605], zoom: 12 }
    };
    const { center, zoom } = cityData[city] || cityData['almaty'];
    console.log('Город:', city, 'Центр:', center, 'Зум:', zoom);

    // Инициализация карты
    let map;
    try {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: center,
        zoom: zoom
      });
      console.log('Карта инициализирована');
    } catch (error) {
      console.error('Ошибка инициализации карты:', error);
      alert('Ошибка загрузки карты. Проверьте токен и интернет.');
      throw error;
    }

    // Проверка канваса
    setTimeout(() => {
      const canvas = mapContainer.querySelector('canvas');
      if (!canvas) {
        console.error('Ошибка: Канвас карты не создан');
        alert('Канвас карты не создан. Проверьте токен или WebGL.');
      } else {
        console.log('Канвас карты создан, размеры:', canvas.width, 'x', canvas.height);
      }
    }, 1000);

    // Опасные места
    const dangerousPlaces = [
      { lng: 76.8897, lat: 43.2389, desc: 'Алматы: центр, высокая преступность' },
      { lng: 76.9667, lat: 43.2333, desc: 'Медеуский район: кражи' },
      { lng: 71.4295, lat: 51.1282, desc: 'Астана: Байтерек, мелкие кражи' }
    ];

    // Геолокация
    let userLocation = null;
    let userMarker = null;
    const dangerRadius = 0.01; // ~1 км

    function checkDangerProximity(coords) {
      console.log('Проверка опасных зон, координаты:', coords);
      if (!coords || !Array.isArray(coords) || coords.length !== 2 || isNaN(coords[0]) || isNaN(coords[1])) {
        console.error('Ошибка: Неверные координаты:', coords);
        return false;
      }
      for (let place of dangerousPlaces) {
        const dist = Math.sqrt(
          Math.pow(coords[0] - place.lng, 2) + Math.pow(coords[1] - place.lat, 2)
        );
        if (dist < dangerRadius) {
          console.log('Опасная зона:', place.desc);
          alert(`Осторожно! Вы рядом с опасной зоной: ${place.desc}`);
          return true;
        }
      }
      console.log('Пользователь в безопасной зоне');
      return false;
    }

    function updateGeolocation() {
      console.log('Запуск геолокации');
      navigator.geolocation.getCurrentPosition(
        (position) => {
          userLocation = [position.coords.longitude, position.coords.latitude];
          console.log('Геолокация получена:', userLocation);

          // Обновление маркера
          if (userMarker) {
            userMarker.setLngLat(userLocation);
            console.log('Синий маркер обновлён:', userLocation);
          } else {
            userMarker = new mapboxgl.Marker({ color: 'blue' })
              .setLngLat(userLocation)
              .addTo(map);
            console.log('Синий маркер добавлен:', userLocation);
          }

          // Центрирование
          map.setCenter(userLocation);
          console.log('Карта центрирована:', userLocation);

          // Проверка опасных зон
          checkDangerProximity(userLocation);
        },
        (error) => {
          console.error('Ошибка геолокации:', error.message);
          userLocation = center;
          console.log('Используется центр региона:', userLocation);
          alert('Геолокация недоступна. Используется центр региона.');
          if (!userMarker) {
            userMarker = new mapboxgl.Marker({ color: 'blue' })
              .setLngLat(userLocation)
              .addTo(map);
            console.log('Синий маркер добавлен (резерв):', userLocation);
          }
          map.setCenter(userLocation);
        },
        { timeout: 10000, maximumAge: 0, enableHighAccuracy: true }
      );
    }

    map.on('load', () => {
      console.log('Карта загружена');

      // Тестовый слой (красный круг)
      map.addSource('test-circle', {
        type: 'geojson',
        data: {
          type: 'Feature',
          geometry: {
            type: 'Point',
            coordinates: center
          }
        }
      });
      map.addLayer({
        id: 'test-circle',
        type: 'circle',
        source: 'test-circle',
        paint: {
          'circle-radius': 10,
          'circle-color': '#ff0000'
        }
      });
      console.log('Тестовый круг добавлен:', center);

      // Опасные места
      console.log('Добавление опасных мест');
      dangerousPlaces.forEach(place => {
        console.log('Добавление маркера:', place.desc, [place.lng, place.lat]);
        new mapboxgl.Marker({
          element: document.createElement('div'),
          className: 'warning-marker'
        })
          .setLngLat([place.lng, place.lat])
          .setPopup(new mapboxgl.Popup().setHTML(<p>${place.desc}</p>))
          .addTo(map);
      });
      console.log('Опасные места добавлены:', dangerousPlaces.length);

      // Геолокация
      updateGeolocation();
      setInterval(updateGeolocation, 10000);
    });

    // Обработка ошибок карты
    map.on('error', (error) => {
      console.error('Ошибка загрузки карты:', error);
      alert('Ошибка загрузки карты: ' + error.message);
    });
  </script>
</body>
</html>