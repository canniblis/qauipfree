<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QauipFree Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; }
    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1;
    }
    #search-input {
      padding: 5px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #search-button {
      padding: 5px 10px;
      background: #210945;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #search-button:hover {
      background: #210945;
    }
    #suggestions {
      position: absolute;
      top: 40px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      width: 200px;
      z-index: 2;
      display: none;
    }
    .suggestion-item {
      padding: 5px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #f0f0f0;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="search-container">
    <input id="search-input" type="text" placeholder="Search for a place" />
    <button id="search-button">Найти</button>
    <div id="suggestions"></div>
  </div>
  <script>
    // Вставь свой MapBox токен
    mapboxgl.accessToken = 'pk.eyJ1IjoicWF1aXBmcmVlIiwiYSI6ImNtOGN2bG11NjJmMHoyanIzdGh5eWt6ankifQ.h5j64FxBh_zi9G3IdAGpZQ';

    // Проверка токена
    if (!mapboxgl.accessToken || mapboxgl.accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
      console.error('Ошибка: Вставьте валидный MapBox токен');
      alert('Карта не загрузилась: отсутствует токен MapBox');
    }

    // Получить параметры из URL
    const urlParams = new URLSearchParams(window.location.search);
    const city = urlParams.get('city') || 'almaty';
    let initialSearch = urlParams.get('search') || '';

    // Координаты и масштаб
    const cityData = {
      'almaty': { center: [76.8897, 43.2389], zoom: 12 },
      'almaty_region': { center: [77.5000, 43.5000], zoom: 8 },
      'astana': { center: [71.4459, 51.1605], zoom: 12 },
      'kazakhstan': { center: [66.9237, 48.0196], zoom: 5 }
    };
    const { center, zoom } = cityData[city] || cityData['almaty'];

    // Инициализация карты
    let map;
    try {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: center,
        zoom: zoom
      });
      console.log('Карта инициализирована');
    } catch (error) {
      console.error('Ошибка инициализации карты:', error);
      alert('Не удалось загрузить карту');
    }

    // Опасные места
    const dangerousPlaces = [
      { lng: 76.8897, lat: 43.2389, desc: 'Алматы: 24,965 преступлений' },
      { lng: 76.9667, lat: 43.2333, desc: 'Медеуский район: кражи, грабежи' },
      { lng: 76.8667, lat: 43.3167, desc: 'Алатауский район: Шанырак, Улжан' },
      { lng: 76.9167, lat: 43.2167, desc: 'Бостандыкский район: угоны' },
      { lng: 76.9333, lat: 43.3000, desc: 'Турксибский район: хулиганство' },
      { lng: 71.4295, lat: 51.1282, desc: 'Астана: район Байтерек, мелкие кражи' },
      { lng: 71.4000, lat: 51.1000, desc: 'Астана: район Mega Silk Way, хулиганство' }
    ];

    // Безопасные места
    const safePlaces = [
      // === Алматы (город) ===
      { name: 'Школа №25', lng: 76.9167, lat: 43.2500, type: 'school', region: 'almaty' },
      { name: 'Гимназия №15', lng: 76.9333, lat: 43.2333, type: 'school', region: 'almaty' },
      { name: 'Школа-лицей №28', lng: 76.9000, lat: 43.2667, type: 'school', region: 'almaty' },
      { name: 'Haileybury Almaty', lng: 76.8577, lat: 43.2167, type: 'school', region: 'almaty' },
      { name: 'Almaty International School', lng: 76.8900, lat: 43.2200, type: 'school', region: 'almaty' },
      { name: 'Мiras International School', lng: 76.8700, lat: 43.2100, type: 'school', region: 'almaty' },
      { name: 'Школа №56', lng: 76.9400, lat: 43.2800, type: 'school', region: 'almaty' },
      { name: 'Гимназия №68', lng: 76.9100, lat: 43.2400, type: 'school', region: 'almaty' },
      { name: 'Городская больница №7', lng: 76.9000, lat: 43.2500, type: 'hospital', region: 'almaty' },
      { name: 'Детская больница №2', lng: 76.8833, lat: 43.2667, type: 'hospital', region: 'almaty' },
      { name: 'Центральная клиническая больница', lng: 76.9200, lat: 43.2300, type: 'hospital', region: 'almaty' },
      { name: 'Городская поликлиника №5', lng: 76.9300, lat: 43.2600, type: 'hospital', region: 'almaty' },
      { name: 'Кардиологический центр', lng: 76.9100, lat: 43.2450, type: 'hospital', region: 'almaty' },
      { name: 'Институт педиатрии', lng: 76.8950, lat: 43.2550, type: 'hospital', region: 'almaty' },
      { name: 'Аптека на Абая', lng: 76.9167, lat: 43.2389, type: 'pharmacy', region: 'almaty' },
      { name: 'Еврофарма', lng: 76.9400, lat: 43.2500, type: 'pharmacy', region: 'almaty' },
      { name: 'Аптека Биосфера', lng: 76.9100, lat: 43.2700, type: 'pharmacy', region: 'almaty' },
      { name: 'Аптека на Жибек Жолы', lng: 76.9500, lat: 43.2600, type: 'pharmacy', region: 'almaty' },
      { name: 'Полицейский участок Медеуского района', lng: 76.9667, lat: 43.2333, type: 'police', region: 'almaty' },
      { name: 'Участок Турксибского района', lng: 76.9333, lat: 43.3000, type: 'police', region: 'almaty' },
      { name: 'Управление полиции Бостандыкского района', lng: 76.9100, lat: 43.2200, type: 'police', region: 'almaty' },
      { name: 'Полицейский участок Алатауского района', lng: 76.8700, lat: 43.3100, type: 'police', region: 'almaty' },
      { name: 'Ресторан Нават', lng: 76.9267, lat: 43.2389, type: 'restaurant', region: 'almaty' },
      { name: 'KFC на Абая', lng: 76.9100, lat: 43.2380, type: 'restaurant', region: 'almaty' },
      { name: 'Vanilla Cafe', lng: 76.9200, lat: 43.2450, type: 'cafe', region: 'almaty' },
      { name: 'Coffee Centre', lng: 76.9400, lat: 43.2350, type: 'cafe', region: 'almaty' },
      { name: 'Honest Coffeehouse', lng: 76.9300, lat: 43.2400, type: 'cafe', region: 'almaty' },
      { name: 'Cafe Nedelka', lng: 76.9450, lat: 43.2500, type: 'cafe', region: 'almaty' },
      { name: 'Urban Coffee', lng: 76.9350, lat: 43.2550, type: 'cafe', region: 'almaty' },
      { name: 'Big Apple Coffee Shop', lng: 76.9250, lat: 43.2600, type: 'cafe', region: 'almaty' },
      { name: 'Shafran Café', lng: 76.9150, lat: 43.2300, type: 'cafe', region: 'almaty' },
      { name: 'Qaimaq Restaurant', lng: 76.9000, lat: 43.2350, type: 'restaurant', region: 'almaty' },
      { name: 'Ocean Basket Mega Center', lng: 76.8987, lat: 43.2033, type: 'restaurant', region: 'almaty' },
      { name: 'ТРЦ Mega Alma-Ata', lng: 76.8987, lat: 43.2033, type: 'shop', region: 'almaty' },
      { name: 'Esentai Mall', lng: 76.9100, lat: 43.2189, type: 'shop', region: 'almaty' },
      { name: 'Dostyk Plaza', lng: 76.9400, lat: 43.2333, type: 'shop', region: 'almaty' },
      { name: 'Atakent Mall', lng: 76.8700, lat: 43.2250, type: 'shop', region: 'almaty' },
      { name: 'Moskva Metropolitan', lng: 76.9000, lat: 43.2400, type: 'shop', region: 'almaty' },
      { name: 'Asia Park', lng: 76.9200, lat: 43.2700, type: 'shop', region: 'almaty' },
      { name: 'Парк Первого Президента', lng: 76.8667, lat: 43.2167, type: 'park', region: 'almaty' },
      { name: 'Горький Парк', lng: 76.9500, lat: 43.2550, type: 'park', region: 'almaty' },
      { name: 'Парк 28 Панфиловцев', lng: 76.9600, lat: 43.2600, type: 'park', region: 'almaty' },
      { name: 'Ботанический сад', lng: 76.8900, lat: 43.2200, type: 'park', region: 'almaty' },
      { name: 'Терренкур', lng: 76.9200, lat: 43.2100, type: 'park', region: 'almaty' },
      { name: 'Банк Халык', lng: 76.9400, lat: 43.2450, type: 'bank', region: 'almaty' },
      { name: 'Kaspi Bank на Абая', lng: 76.9300, lat: 43.2380, type: 'bank', region: 'almaty' },
      { name: 'ForteBank', lng: 76.9100, lat: 43.2500, type: 'bank', region: 'almaty' },
      { name: 'Зелёный базар', lng: 76.9400, lat: 43.2600, type: 'market', region: 'almaty' },
      { name: 'Кок-Тобе', lng: 76.9700, lat: 43.2300, type: 'attraction', region: 'almaty' },
      { name: 'Вознесенский собор', lng: 76.9600, lat: 43.2600, type: 'attraction', region: 'almaty' },
      { name: 'Алматы Арбат', lng: 76.9500, lat: 43.2550, type: 'attraction', region: 'almaty' },
      { name: 'Оперный театр Абая', lng: 76.9400, lat: 43.2500, type: 'theatre', region: 'almaty' },
      { name: 'Музей искусств Кастеева', lng: 76.9000, lat: 43.2300, type: 'museum', region: 'almaty' },
      { name: 'Центральная мечеть Алматы', lng: 76.9500, lat: 43.2650, type: 'mosque', region: 'almaty' },
      { name: 'Республиканская площадь', lng: 76.9400, lat: 43.2400, type: 'attraction', region: 'almaty' },

      // === Алматинская область ===
      { name: 'Чарынский каньон', lng: 79.0544, lat: 43.3553, type: 'attraction', region: 'almaty_region' },
      { name: 'Озеро Каинды', lng: 78.4667, lat: 42.9833, type: 'attraction', region: 'almaty_region' },
      { name: 'Озеро Колсай', lng: 78.3333, lat: 42.9167, type: 'attraction', region: 'almaty_region' },
      { name: 'Большое Алматинское озеро', lng: 76.9833, lat: 43.0500, type: 'attraction', region: 'almaty_region' },
      { name: 'Алтын-Эмель (Поющий бархан)', lng: 78.7500, lat: 44.1553, type: 'attraction', region: 'almaty_region' },
      { name: 'Иле-Алатау Национальный парк', lng: 76.9500, lat: 43.1000, type: 'park', region: 'almaty_region' },
      { name: 'Озеро Иссык', lng: 77.4833, lat: 43.2500, type: 'attraction', region: 'almaty_region' },
      { name: 'Плато Асы', lng: 78.8000, lat: 43.6000, type: 'attraction', region: 'almaty_region' },
      { name: 'Шымбулак (горнолыжный курорт)', lng: 76.9667, lat: 43.1333, type: 'attraction', region: 'almaty_region' },
      { name: 'Медеу (каток)', lng: 76.9667, lat: 43.1667, type: 'attraction', region: 'almaty_region' },
      { name: 'Oi-Qaragai Mountain Resort', lng: 76.8333, lat: 43.1667, type: 'attraction', region: 'almaty_region' },
      { name: 'Талдыкорган', lng: 78.3739, lat: 45.0156, type: 'city', region: 'almaty_region' },
      { name: 'Конаев', lng: 77.0597, lat: 43.8803, type: 'city', region: 'almaty_region' },
      { name: 'Есик', lng: 77.4667, lat: 43.3667, type: 'city', region: 'almaty_region' },
      { name: 'Капчагай', lng: 77.0667, lat: 43.8667, type: 'city', region: 'almaty_region' },
      { name: 'Каскелен', lng: 76.6167, lat: 43.2000, type: 'city', region: 'almaty_region' },
      { name: 'Музей Жансугурова (Талдыкорган)', lng: 78.3739, lat: 45.0156, type: 'museum', region: 'almaty_region' },
      { name: 'Музей жертв политических репрессий', lng: 78.3739, lat: 45.0156, type: 'museum', region: 'almaty_region' },
      { name: 'Тургенский водопад', lng: 77.6000, lat: 43.3000, type: 'attraction', region: 'almaty_region' },
      { name: 'Кафе Шымбулак', lng: 76.9667, lat: 43.1333, type: 'cafe', region: 'almaty_region' },
      { name: 'Ресторан в Капчагае', lng: 77.0667, lat: 43.8667, type: 'restaurant', region: 'almaty_region' },

      // === Астана ===
      { name: 'Байтерек', lng: 71.4295, lat: 51.1282, type: 'attraction', region: 'astana' },
      { name: 'Хан Шатыр', lng: 71.4028, lat: 51.1328, type: 'shop', region: 'astana' },
      { name: 'Дворец мира и согласия', lng: 71.4667, lat: 51.1167, type: 'attraction', region: 'astana' },
      { name: 'Национальный музей Казахстана', lng: 71.4667, lat: 51.1333, type: 'museum', region: 'astana' },
      { name: 'Мечеть Хазрет Султан', lng: 71.4667, lat: 51.1500, type: 'mosque', region: 'astana' },
      { name: 'Мечеть Нур-Астана', lng: 71.4333, lat: 51.1667, type: 'mosque', region: 'astana' },
      { name: 'Акорда (Президентский дворец)', lng: 71.4500, lat: 51.1250, type: 'attraction', region: 'astana' },
      { name: 'Центральный парк Астаны', lng: 71.4167, lat: 51.1667, type: 'park', region: 'astana' },
      { name: 'Парк влюблённых', lng: 71.4333, lat: 51.1500, type: 'park', region: 'astana' },
      { name: 'Ботанический сад Астаны', lng: 71.4000, lat: 51.1333, type: 'park', region: 'astana' },
      { name: 'ТРЦ Keruen', lng: 71.4167, lat: 51.1333, type: 'shop', region: 'astana' },
      { name: 'Mega Silk Way', lng: 71.4000, lat: 51.1000, type: 'shop', region: 'astana' },
      { name: 'Asia Park Astana', lng: 71.4333, lat: 51.1167, type: 'shop', region: 'astana' },
      { name: 'Назарбаев Университет', lng: 71.4000, lat: 51.0900, type: 'university', region: 'astana' },
      { name: 'Евразийский национальный университет', lng: 71.4167, lat: 51.1500, type: 'university', region: 'astana' },
      { name: 'The Kitchen Astana', lng: 71.4167, lat: 51.1333, type: 'restaurant', region: 'astana' },
      { name: 'Line Brew Astana', lng: 71.4333, lat: 51.1500, type: 'restaurant', region: 'astana' },
      { name: 'Coffee Boom Astana', lng: 71.4000, lat: 51.1167, type: 'cafe', region: 'astana' },
      { name: 'Marrone Rosso Astana', lng: 71.4167, lat: 51.1667, type: 'cafe', region: 'astana' },
      { name: 'Национальный научный медицинский центр', lng: 71.4500, lat: 51.1500, type: 'hospital', region: 'astana' },
      { name: 'Городская больница №1', lng: 71.4333, lat: 51.1667, type: 'hospital', region: 'astana' },
      { name: 'Детская больница Астаны', lng: 71.4167, lat: 51.1333, type: 'hospital', region: 'astana' },
      { name: 'Аптека Europharma Astana', lng: 71.4167, lat: 51.1500, type: 'pharmacy', region: 'astana' },
      { name: 'Аптека на Байтереке', lng: 71.4295, lat: 51.1282, type: 'pharmacy', region: 'astana' },
      { name: 'Участок Алматинского района Астаны', lng: 71.4167, lat: 51.1333, type: 'police', region: 'astana' },
      { name: 'Участок Есильского района', lng: 71.4000, lat: 51.1167, type: 'police', region: 'astana' }
    ];

    // Геолокация
    let userLocation = null;
    navigator.geolocation.getCurrentPosition(
      (position) => {
        userLocation = [position.coords.longitude, position.coords.latitude];
        console.log('Геолокация:', userLocation);
        if (cityData[city]) {
          map.setCenter(userLocation);
          map.setZoom(cityData[city].zoom);
        }
        new mapboxgl.Marker({ color: 'blue' })
          .setLngLat(userLocation)
          .addTo(map);
      },
      (error) => {
        console.error('Ошибка геолокации:', error);
        userLocation = cityData[city].center; // Fallback на центр региона
        console.log('Fallback-координаты:', userLocation);
        alert('Геолокация недоступна. Используется центр региона.');
        new mapboxgl.Marker({ color: 'blue' })
          .setLngLat(userLocation)
          .addTo(map);
      }
    );

    // Функция проверки координат
    function isValidCoords(coords) {
      return Array.isArray(coords) && coords.length === 2 && 
             typeof coords[0] === 'number' && typeof coords[1] === 'number' && 
             !isNaN(coords[0]) && !isNaN(coords[1]);
    }

    // Проверка маршрута
    function isRouteSafe(route, dangerousPlaces) {
      try {
        const routeCoords = route.geometry.coordinates;
        for (let place of dangerousPlaces) {
          const dangerRadius = 0.007;
          for (let coord of routeCoords) {
            const dist = Math.sqrt(
              Math.pow(coord[0] - place.lng, 2) + Math.pow(coord[1] - place.lat, 2)
            );
            if (dist < dangerRadius) {
              console.log('Маршрут пересекает опасную зону:', place.desc);
              return false;
            }
          }
        }
        return true;
      } catch (error) {
        console.error('Ошибка проверки маршрута:', error);
        return true; // Пропускаем проверку при ошибке
      }
    }

    map.on('load', () => {
      console.log('Карта загружена');

      // Кастомная иконка для опасных мест
      try {
        const warningIcon = new Image(24, 24);
        warningIcon.src = 'data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiAyMkgxOCAyMkwxMiAyWiIgZmlsbD0icmVkIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjIiLz4KPHRleHQgeD0iMTIiIHk9IjE4IiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC13ZWlnaHQ9ImJvbGQiPiE8L3RleHQ+Cjwvc3ZnPg==';
        map.addImage('warning-icon', warningIcon);

        dangerousPlaces.forEach(place => {
          new mapboxgl.Marker({ element: document.createElement('div') })
            .setLngLat([place.lng, place.lat])
            .setPopup(new mapboxgl.Popup().setHTML(<p>${place.desc}</p>))
            .addTo(map)
            .getElement().innerHTML = '<img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiAyMkgxOCAyMkwxMiAyWiIgZmlsbD0icmVkIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjIiLz4KPHRleHQgeD0iMTIiIHk9IjE4IiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC13ZWlnaHQ9ImJvbGQiPiE8L3RleHQ+Cjwvc3ZnPg==" style="width: 24px; height: 24px;">';
        });
      } catch (error) {
        console.error('Ошибка добавления опасных мест:', error);
      }

      // Функция поиска и построения маршрута
      function performSearch(searchQuery, coordinates) {
        if (!searchQuery && !coordinates) {
          console.log('Пустой запрос');
          alert('Введите место для поиска');
          return;
        }
        console.log('Поиск:', searchQuery, coordinates);

        // Перевод запросов
        const queryMap = {
          'полиция': 'police',
          'больница': 'hospital',
          'аптека': 'pharmacy',
          'участок': 'police',
          'школа': 'school',
          'ресторан': 'restaurant',
          'кафе': 'cafe',
          'магазин': 'shop',
          'парк': 'park',
          'банк': 'bank',
          'почта': 'post_office',
          'музей': 'museum',
          'театр': 'theatre',
          'отель': 'hotel',
          'трц': 'shop',
          'остановка': 'bus_station',
          'мега': 'shop',
          'байтерек': 'attraction',
          'чарын': 'attraction',
          'шымбулак': 'attraction'
        };
        const search = queryMap[searchQuery.toLowerCase()] || searchQuery;

        // Удалить старый маршрут и маркер
        try {
          if (map.getLayer('route')) {
            map.removeLayer('route');
            map.removeSource('route');
          }
          const existingMarker = document.querySelector('.safe-marker');
          if (existingMarker) existingMarker.remove();
        } catch (error) {
          console.error('Ошибка удаления маршрута/маркера:', error);
        }

        // Локальный поиск
        const localPlace = safePlaces.find(place => 
          (place.region === city || city === 'kazakhstan') && 
          (place.name.toLowerCase().includes(search.toLowerCase()) || 
           place.type.toLowerCase() === search.toLowerCase())
        );
        if (localPlace) {
          console.log('Локальное место:', localPlace);
          const safeLocation = [localPlace.lng, localPlace.lat];
          new mapboxgl.Marker({ color: 'green', className: 'safe-marker' })
            .setLngLat(safeLocation)
            .setPopup(new mapboxgl.Popup().setHTML(<p>${localPlace.name}</p>))
            .addTo(map);

          // Построить маршрут
          if (isValidCoords(userLocation) && isValidCoords(safeLocation)) {
            console.log('Запрос маршрута:', { userLocation, safeLocation });
            fetch(https://api.mapbox.com/directions/v5/mapbox/walking/${userLocation[0]},${userLocation[1]};${safeLocation[0]},${safeLocation[1]}?access_token=${mapboxgl.accessToken})
              .then(response => {
                console.log('Directions API:', response.status, response.statusText);
                if (!response.ok) throw new Error(HTTP ошибка: ${response.status} ${response.statusText});
                return response.json();
              })
              .then(data => {
                console.log('Данные маршрута:', data);
                if (data.routes && data.routes.length > 0) {
                  const route = data.routes[0];
                  if (isRouteSafe(route, dangerousPlaces)) {
                    console.log('Маршрут безопасен:', route);
                    map.addLayer({
                      id: 'route',
                      type: 'line',
                      source: {
                        type: 'geojson',
                        data: {
                          type: 'Feature',
                          geometry: route.geometry
                        }
                      },
                      paint: { 'line-color': '#3887be', 'line-width': 5 }
                    });
                  } else {
                    console.log('Маршрут небезопасен');
                    alert('Маршрут пересекает опасную зону. Попробуйте другое место.');
                  }
                } else {
                  console.log('Маршрут не найден:', data);
                  alert('Маршрут не найден. Возможно, место слишком далеко или API недоступен.');
                }
              })
              .catch(error => {
                console.error('Ошибка маршрута:', error);
                alert('Ошибка построения маршрута: ' + error.message);
              });
          } else {
            console.log('Неверные координаты:', { userLocation, safeLocation });
            alert('Маршрут не построен: неверные координаты.');
          }
          return;
        }

        // Поиск по координатам (автодополнение)
        if (coordinates && isValidCoords(coordinates)) {
          console.log('Поиск по координатам:', coordinates);
          const safeLocation = coordinates;
          new mapboxgl.Marker({ color: 'green', className: 'safe-marker' })
            .setLngLat(safeLocation)
            .setPopup(new mapboxgl.Popup().setHTML(<p>${searchQuery}</p>))
            .addTo(map);

          if (isValidCoords(userLocation) && isValidCoords(safeLocation)) {
            console.log('Запрос маршрута:', { userLocation, safeLocation });
            fetch(https://api.mapbox.com/directions/v5/mapbox/walking/${userLocation[0]},${userLocation[1]};${safeLocation[0]},${safeLocation[1]}?access_token=${mapboxgl.accessToken})
              .then(response => {
                console.log('Directions API:', response.status, response.statusText);
                if (!response.ok) throw new Error(HTTP ошибка: ${response.status} ${response.statusText});
                return response.json();
              })
              .then(data => {
                console.log('Данные маршрута:', data);
                if (data.routes && data.routes.length > 0) {
                  const route = data.routes[0];
                  if (isRouteSafe(route, dangerousPlaces)) {
                    console.log('Маршрут безопасен:', route);
                    map.addLayer({
                      id: 'route',
                      type: 'line',
                      source: {
                        type: 'geojson',
                        data: {
                          type: 'Feature',
                          geometry: route.geometry
                        }
                      },
                      paint: { 'line-color': '#3887be', 'line-width': 5 }
                    });
                  } else {
                    console.log('Маршрут небезопасен');
                    alert('Маршрут пересекает опасную зону. Попробуйте другое место.');
                  }
                } else {
                  console.log('Маршрут не найден:', data);
                  alert('Маршрут не найден. Возможно, место слишком далеко или API недоступен.');
                }
              })
              .catch(error => {
                console.error('Ошибка маршрута:', error);
                alert('Ошибка построения маршрута: ' + error.message);
              });
          } else {
            console.log('Неверные координаты:', { userLocation, safeLocation });
            alert('Маршрут не построен: неверные координаты.');
          }
          return;
        }

        // Поиск через MapBox API
        console.log('Поиск MapBox:', search);
        fetch(https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(search)}.json?proximity=${center[0]},${center[1]}&access_token=${mapboxgl.accessToken})
          .then(response => {
            console.log('Geocoding API:', response.status, response.statusText);
            if (!response.ok) throw new Error(HTTP ошибка: ${response.status} ${response.statusText});
            return response.json();
          })
          .then(data => {
            if (data.features && data.features[0]) {
              console.log('Найдено:', data.features[0]);
              const safeLocation = data.features[0].center;
              new mapboxgl.Marker({ color: 'green', className: 'safe-marker' })
                .setLngLat(safeLocation)
                .setPopup(new mapboxgl.Popup().setHTML(<p>${data.features[0].text}</p>))
                .addTo(map);

              if (isValidCoords(userLocation) && isValidCoords(safeLocation)) {
                console.log('Запрос маршрута:', { userLocation, safeLocation });
                fetch(https://api.mapbox.com/directions/v5/mapbox/walking/${userLocation[0]},${userLocation[1]};${safeLocation[0]},${safeLocation[1]}?access_token=${mapboxgl.accessToken})
                  .then(response => {
                    console.log('Directions API:', response.status, response.statusText);
                    if (!response.ok) throw new Error(HTTP ошибка: ${response.status} ${response.statusText});
                    return response.json();
                  })
                  .then(data => {
                    console.log('Данные маршрута:', data);
                    if (data.routes && data.routes.length > 0) {
                      const route = data.routes[0];
                      if (isRouteSafe(route, dangerousPlaces)) {
                        console.log('Маршрут безопасен:', route);
                        map.addLayer({
                          id: 'route',
                          type: 'line',
                          source: {
                            type: 'geojson',
                            data: {
                              type: 'Feature',
                              geometry: route.geometry
                            }
                          },
                          paint: { 'line-color': '#3887be', 'line-width': 5 }
                        });
                      } else {
                        console.log('Маршрут небезопасен');
                        alert('Маршрут пересекает опасную зону. Попробуйте другое место.');
                      }
                    } else {
                      console.log('Маршрут не найден:', data);
                      alert('Маршрут не найден. Возможно, место слишком далеко или API недоступен.');
                    }
                  })
                  .catch(error => {
                    console.error('Ошибка маршрута:', error);
                    alert('Ошибка построения маршрута: ' + error.message);
                  });
              } else {
                console.log('Неверные координаты:', { userLocation, safeLocation });
                alert('Маршрут не построен: неверные координаты.');
              }
            } else {
              console.log('Место не найдено');
              alert('Место не найдено');
            }
          })
          .catch(error => {
            console.error('Ошибка поиска:', error);
            alert('Ошибка поиска: ' + error.message);
          });
      }

      // Автодополнение
      const searchInput = document.getElementById('search-input');
      const suggestions = document.getElementById('suggestions');
      searchInput.addEventListener('input', () => {
        const query = searchInput.value;
        suggestions.innerHTML = '';
        if (query.length < 2) {
          suggestions.style.display = 'none';
          console.log('Короткий запрос:', query);
          return;
        }
        console.log('Автодополнение:', query);
        const queryMap = {
          'полиция': 'police',
          'больница': 'hospital',
          'аптека': 'pharmacy',
          'участок': 'police',
          'школа': 'school',
          'ресторан': 'restaurant',
          'кафе': 'cafe',
          'магазин': 'shop',
          'парк': 'park',
          'банк': 'bank',
          'почта': 'post_office',
          'музей': 'museum',
          'театр': 'theatre',
          'отель': 'hotel',
          'трц': 'shop',
          'остановка': 'bus_station',
          'мега': 'shop',
          'байтерек': 'attraction',
          'чарын': 'attraction',
          'шымбулак': 'attraction'
        };
        const search = queryMap[query.toLowerCase()] || query;

        const localMatches = safePlaces.filter(place => 
          (place.region === city || city === 'kazakhstan') && 
          (place.name.toLowerCase().includes(query.toLowerCase()) || 
           place.type.toLowerCase().includes(query.toLowerCase()))
        );
        localMatches.forEach(place => {
          const item = document.createElement('div');
          item.className = 'suggestion-item';
          item.textContent = place.name;
          item.addEventListener('click', () => {
            console.log('Выбрано:', place.name);
            searchInput.value = place.name;
            suggestions.style.display = 'none';
            performSearch(place.name, [place.lng, place.lat]);
          });
          suggestions.appendChild(item);
        });
        if (localMatches.length > 0) {
          suggestions.style.display = 'block';
          console.log('Локальные места:', localMatches);
        }

        fetch(https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(search)}.json?proximity=${center[0]},${center[1]}&access_token=${mapboxgl.accessToken})
          .then(response => {
            console.log('Geocoding API (автодополнение):', response.status, response.statusText);
            if (!response.ok) throw new Error(HTTP ошибка: ${response.status});
            return response.json();
          })
          .then(data => {
            if (data.features && data.features.length > 0) {
              console.log('Автодополнение MapBox:', data.features);
              data.features.forEach(feature => {
                const item = document.createElement('div');
                item.className = 'suggestion-item';
                item.textContent = feature.text;
                item.addEventListener('click', () => {
                  console.log('Выбрано MapBox:', feature.text);
                  searchInput.value = feature.text;
                  suggestions.style.display = 'none';
                  performSearch(feature.text, feature.center);
                });
                suggestions.appendChild(item);
              });
              suggestions.style.display = 'block';
            } else if (suggestions.childNodes.length === 0) {
              suggestions.style.display = 'none';
              console.log('Нет автодополнения');
            }
          })
          .catch(error => {
            console.error('Ошибка автодополнения:', error);
            alert('Ошибка автодополнения: ' + error.message);
          });
      });

      // Скрыть автодополнение
      document.addEventListener('click', (e) => {
        if (!searchInput.contains(e.target) && !suggestions.contains(e.target)) {
          suggestions.style.display = 'none';
          console.log('Автодополнение скрыто');
        }
      });

      // Кнопка поиска
      document.getElementById('search-button').addEventListener('click', () => {
        const searchQuery = searchInput.value;
        console.log('Поиск по кнопке:', searchQuery);
        performSearch(searchQuery);
      });

      // Enter
      searchInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
          const searchQuery = searchInput.value;
          console.log('Поиск по Enter:', searchQuery);
          performSearch(searchQuery);
        }
      });

      // Начальный поиск
      if (initialSearch) {
        console.log('Начальный поиск:', initialSearch);
        searchInput.value = initialSearch;
        performSearch(initialSearch);
      }
    });
  </script>
</body>
</html>