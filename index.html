<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QauipFree Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map {
      position: absolute;
      top: 0;
      bottom: 0;
      width: 100%;
      height: 100vh;
      background: #f0f0f0; /* Фон для диагностики */
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <script>
    // Вставь свой MapBox токен здесь
    mapboxgl.accessToken = 'pk.eyJ1IjoicWF1aXBmcmVlIiwiYSI6ImNtOGN2bG11NjJmMHoyanIzdGh5eWt6ankifQ.h5j64FxBh_zi9G3IdAGpZQ';

    // Проверка токена
    if (!mapboxgl.accessToken || mapboxgl.accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
      console.error('Ошибка: Вставьте валидный MapBox токен');
      alert('Карта не загрузилась: отсутствует токен MapBox');
      throw new Error('Неверный токен');
    }
    console.log('Токен установлен:', mapboxgl.accessToken.slice(0, 10) + '...');

    // Проверка ресурсов
    console.log('Проверка ресурсов:');
    console.log('MapBox JS:', 'https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js');
    console.log('MapBox CSS:', 'https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css');

    // Проверка контейнера
    const mapContainer = document.getElementById('map');
    if (!mapContainer) {
      console.error('Ошибка: Контейнер #map не найден');
      alert('Ошибка: Контейнер карты не найден');
      throw new Error('Контейнер #map отсутствует');
    }
    console.log('Контейнер #map найден, размеры:', mapContainer.offsetWidth, 'x', mapContainer.offsetHeight);

    // Получить параметры из URL
    const urlParams = new URLSearchParams(window.location.search);
    const city = urlParams.get('city') || 'almaty';

    // Координаты и масштаб
    const cityData = {
      'almaty': { center: [76.8897, 43.2389], zoom: 12 },
      'almaty_region': { center: [77.5000, 43.5000], zoom: 8 },
      'astana': { center: [71.4459, 51.1605], zoom: 12 },
      'kazakhstan': { center: [66.9237, 48.0196], zoom: 5 }
    };
    const { center, zoom } = cityData[city] || cityData['almaty'];
    console.log('Инициализация: Город:', city, 'Центр:', center, 'Зум:', zoom);

    // Проверка координат
    if (!Array.isArray(center) || center.length !== 2 || isNaN(center[0]) || isNaN(center[1])) {
      console.error('Ошибка: Неверные координаты центра:', center);
      alert('Ошибка: Неверные координаты региона');
      throw new Error('Неверные координаты');
    }

    // Инициализация карты
    let map;
    try {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: center,
        zoom: zoom
      });
      console.log('Карта успешно инициализирована');
    } catch (error) {
      console.error('Ошибка инициализации карты:', error);
      alert('Не удалось загрузить карту. Проверьте токен и интернет.');
      throw error;
    }

    // Опасные места
    const dangerousPlaces = [
      { lng: 76.8897, lat: 43.2389, desc: 'Алматы: центр, высокая преступность' },
      { lng: 76.9667, lat: 43.2333, desc: 'Медеуский район: кражи' },
      { lng: 76.8667, lat: 43.3167, desc: 'Алатауский район: Шанырак' },
      { lng: 71.4295, lat: 51.1282, desc: 'Астана: Байтерек, мелкие кражи' },
      { lng: 71.4000, lat: 51.1000, desc: 'Астана: Mega Silk Way' }
    ];

    // Геолокация
    let userLocation = null;
    let userMarker = null;
    const dangerRadius = 0.01; // ~1 км

    function checkDangerProximity(coords) {
      try {
        console.log('Проверка близости к опасным зонам, координаты:', coords);
        for (let place of dangerousPlaces) {
          const dist = Math.sqrt(
            Math.pow(coords[0] - place.lng, 2) + Math.pow(coords[1] - place.lat, 2)
          );
          if (dist < dangerRadius) {
            console.log('Пользователь рядом с опасной зоной:', place.desc);
            alert(`Осторожно! Вы рядом с опасной зоной: ${place.desc}`);
            return true;
          }
        }
        console.log('Пользователь в безопасной зоне');
        return false;
      } catch (error) {
        console.error('Ошибка проверки близости:', error);
        alert('Ошибка проверки опасных зон');
        return false;
      }
    }

    function updateGeolocation() {
      try {
        navigator.geolocation.getCurrentPosition(
          (position) => {
            userLocation = [position.coords.longitude, position.coords.latitude];
            console.log('Геолокация получена:', userLocation);

            // Обновление маркера
            if (userMarker) {
              userMarker.setLngLat(userLocation);
            } else {
              userMarker = new mapboxgl.Marker({ color: 'blue' })
                .setLngLat(userLocation)
                .addTo(map);
            }

            // Центрирование карты
            map.setCenter(userLocation);

            // Проверка близости к опасным зонам
            checkDangerProximity(userLocation);
          },
          (error) => {
            console.error('Ошибка геолокации:', error);
            userLocation = cityData[city].center;
            console.log('Используется центр региона:', userLocation);
            alert('Геолокация недоступна. Используется центр региона.');
            if (!userMarker) {
              userMarker = new mapboxgl.Marker({ color: 'blue' })
                .setLngLat(userLocation)
                .addTo(map);
              map.setCenter(userLocation);
            }
          },
          { timeout: 10000, maximumAge: 0, enableHighAccuracy: true }
        );
      } catch (error) {
        console.error('Ошибка настройки геолокации:', error);
        alert('Ошибка настройки геолокации');
      }
    }

    map.on('load', () => {
      console.log('Карта полностью загружена');

      // Тестовый маркер для проверки рендеринга
      try {
        console.log('Попытка добавить тестовый маркер в центре:', center);
        if (map && Array.isArray(center) && center.length === 2) {
          new mapboxgl.Marker({ color: 'red' })
            .setLngLat(center)
            .addTo(map);
          console.log('Тестовый маркер успешно добавлен');
        } else {
          console.error('Ошибка: Карта или координаты недоступны для тестового маркера');
        }
      } catch (error) {
        console.error('Ошибка добавления тестового маркера:', error);
        alert('Ошибка добавления тестового маркера');
      }

      // Добавление опасных мест
      try {
        dangerousPlaces.forEach(place => {
          new mapboxgl.Marker({ className: 'warning-marker' })
            .setLngLat([place.lng, place.lat])
            .setPopup(new mapboxgl.Popup().setHTML(<p>${place.desc}</p>))
            .addTo(map);
        });
        console.log('Опасные места добавлены:', dangerousPlaces.length);
      } catch (error) {
        console.error('Ошибка добавления опасных мест:', error);
        alert('Ошибка добавления опасных зон');
      }

      // Начальная геолокация
      updateGeolocation();

      // Обновление геолокации каждые 10 секунд
      setInterval(updateGeolocation, 10000);
    });

    // Обработка ошибок карты
    map.on('error', (error) => {
      console.error('Ошибка загрузки карты:', error);
      alert('Ошибка загрузки карты: ' + error.message);
    });
  </script>
</body>
</html>