<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>QauipFree Map</title>
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <script src="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.js"></script>
  <link href="https://api.mapbox.com/mapbox-gl-js/v2.9.0/mapbox-gl.css" rel="stylesheet" />
  <style>
    body { margin: 0; padding: 0; }
    #map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100vh; }
    #search-container {
      position: absolute;
      top: 10px;
      left: 10px;
      background: white;
      padding: 10px;
      border-radius: 5px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1;
    }
    #search-input {
      padding: 5px;
      width: 200px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }
    #search-button {
      padding: 5px 10px;
      background: #3887be;
      color: white;
      border: none;
      border-radius: 3px;
      cursor: pointer;
    }
    #search-button:hover {
      background: #2a6a9e;
    }
    #suggestions {
      position: absolute;
      top: 40px;
      left: 10px;
      background: white;
      border: 1px solid #ccc;
      border-radius: 3px;
      max-height: 150px;
      overflow-y: auto;
      width: 200px;
      z-index: 2;
      display: none;
    }
    .suggestion-item {
      padding: 5px;
      cursor: pointer;
    }
    .suggestion-item:hover {
      background: #f0f0f0;
    }
    .mapboxgl-marker.warning-marker {
      background-image: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMjQiIGhlaWdodD0iMjQiIHZpZXdCb3g9IjAgMCAyNCAyNCIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj4KPHBhdGggZD0iTTEyIDJMMiAyMkgxOCAyMkwxMiAyWiIgZmlsbD0icmVkIiBzdHJva2U9ImJsYWNrIiBzdHJva2Utd2lkdGg9IjIiLz4KPHRleHQgeD0iMTIiIHk9IjE4IiBmb250LXNpemU9IjE2IiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmaWxsPSJ3aGl0ZSIgZm9udC13ZWlnaHQ9ImJvbGQiPiE8L3RleHQ+Cjwvc3ZnPg==');
      background-size: 24px 24px;
      width: 24px;
      height: 24px;
    }
  </style>
</head>
<body>
  <div id="map"></div>
  <div id="search-container">
    <input id="search-input" type="text" placeholder="Введите место (школа, кафе, Байтерек, Чарын)" />
    <button id="search-button">Найти</button>
    <div id="suggestions"></div>
  </div>
  <script>
    // Вставь свой MapBox токен здесь
    mapboxgl.accessToken = 'pk.eyJ1IjoicWF1aXBmcmVlIiwiYSI6ImNtYTN6YTBrbTAxOXYycnM4ZjE4ZG9sejIifQ.UxK3klpjrLBMMUW7FwG24g';

    // Проверка токена
    if (!mapboxgl.accessToken || mapboxgl.accessToken === 'YOUR_MAPBOX_ACCESS_TOKEN') {
      console.error('Ошибка: Вставьте валидный MapBox токен');
      alert('Карта не загрузилась: отсутствует токен MapBox');
      throw new Error('Неверный токен');
    }

    // Получить параметры из URL
    const urlParams = new URLSearchParams(window.location.search);
    const city = urlParams.get('city') || 'almaty';
    const initialSearch = urlParams.get('search') || '';

    // Координаты и масштаб
    const cityData = {
      'almaty': { center: [76.8897, 43.2389], zoom: 12 },
      'almaty_region': { center: [77.5000, 43.5000], zoom: 8 },
      'astana': { center: [71.4459, 51.1605], zoom: 12 },
      'kazakhstan': { center: [66.9237, 48.0196], zoom: 5 }
    };
    const { center, zoom } = cityData[city] || cityData['almaty'];
    console.log('Город:', city, 'Центр:', center, 'Зум:', zoom);

    // Инициализация карты
    let map;
    try {
      map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v11',
        center: center,
        zoom: zoom
      });
      console.log('Карта инициализирована');
    } catch (error) {
      console.error('Ошибка инициализации карты:', error);
      alert('Не удалось загрузить карту');
      throw error;
    }

    // Опасные места
    const dangerousPlaces = [
      { lng: 76.8897, lat: 43.2389, desc: 'Алматы: центр, высокая преступность' },
      { lng: 76.9667, lat: 43.2333, desc: 'Медеуский район: кражи' },
      { lng: 76.8667, lat: 43.3167, desc: 'Алатауский район: Шанырак' },
      { lng: 71.4295, lat: 51.1282, desc: 'Астана: Байтерек, мелкие кражи' },
      { lng: 71.4000, lat: 51.1000, desc: 'Астана: Mega Silk Way' }
    ];

    // Безопасные места
    const safePlaces = [
      // === Алматы ===
      { name: 'Школа №25', lng: 76.9167, lat: 43.2500, type: 'school', region: 'almaty' },
      { name: 'Гимназия №15', lng: 76.9333, lat: 43.2333, type: 'school', region: 'almaty' },
      { name: 'Городская больница №7', lng: 76.9000, lat: 43.2500, type: 'hospital', region: 'almaty' },
      { name: 'Аптека на Абая', lng: 76.9167, lat: 43.2389, type: 'pharmacy', region: 'almaty' },
      { name: 'Полицейский участок Медеуского района', lng: 76.9667, lat: 43.2333, type: 'police', region: 'almaty' },
      { name: 'Ресторан Нават', lng: 76.9267, lat: 43.2389, type: 'restaurant', region: 'almaty' },
      { name: 'Vanilla Cafe', lng: 76.9200, lat: 43.2450, type: 'cafe', region: 'almaty' },
      { name: 'ТРЦ Mega Alma-Ata', lng: 76.8987, lat: 43.2033, type: 'shop', region: 'almaty' },
      { name: 'Парк 28 Панфиловцев', lng: 76.9600, lat: 43.2600, type: 'park', region: 'almaty' },
      { name: 'Кок-Тобе', lng: 76.9700, lat: 43.2300, type: 'attraction', region: 'almaty' },
      { name: 'Музей Кастеева', lng: 76.9000, lat: 43.2300, type: 'museum', region: 'almaty' },
      { name: 'Оперный театр Абая', lng: 76.9400, lat: 43.2500, type: 'theatre', region: 'almaty' },
      // === Алматинская область ===
      { name: 'Чарынский каньон', lng: 79.0544, lat: 43.3553, type: 'attraction', region: 'almaty_region' },
      { name: 'Шымбулак', lng: 76.9667, lat: 43.1333, type: 'attraction', region: 'almaty_region' },
      { name: 'Озеро Каинды', lng: 78.4667, lat: 42.9833, type: 'attraction', region: 'almaty_region' },
      { name: 'Большое Алматинское озеро', lng: 76.9833, lat: 43.0500, type: 'attraction', region: 'almaty_region' },
      { name: 'Талдыкорган', lng: 78.3739, lat: 45.0156, type: 'city', region: 'almaty_region' },
      { name: 'Медеу', lng: 76.9667, lat: 43.1667, type: 'attraction', region: 'almaty_region' },
      // === Астана ===
      { name: 'Байтерек', lng: 71.4295, lat: 51.1282, type: 'attraction', region: 'astana' },
      { name: 'Хан Шатыр', lng: 71.4028, lat: 51.1328, type: 'shop', region: 'astana' },
      { name: 'Мечеть Хазрет Султан', lng: 71.4667, lat: 51.1500, type: 'mosque', region: 'astana' },
      { name: 'Национальный музей', lng: 71.4667, lat: