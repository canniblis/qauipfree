<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapbox Safe Routes in Almaty</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <script src='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.js'></script>
    <link href='https://api.mapbox.com/mapbox-gl-js/v3.2.0/mapbox-gl.css' rel='stylesheet' />
    <script src='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.js'></script>
    <link rel='stylesheet' href='https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-directions/v4.3.1/mapbox-gl-directions.css' type='text/css' />
    <style>
        body { margin: 0; padding: 0; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        .marker {
            background-image: url('https://upload.wikimedia.org/wikipedia/commons/thumb/3/3b/Red_triangle_with_exclamation_mark.svg/24px-Red_triangle_with_exclamation_mark.svg.png');
            background-size: cover;
            width: 24px;
            height: 24px;
            cursor: pointer;
        }
        .mapboxgl-popup-content {
            font-family: Arial, sans-serif;
            font-size: 14px;
            max-width: 200px;
        }
    </style>
</head>
<body>
<div id='map'></div>

<script>
    // Ваш Mapbox Access Token
    mapboxgl.accessToken = 'pk.eyJ1IjoicWF1aXBmcmVlIiwiYSI6ImNtOGN2bG11NjJmMHoyanIzdGh5eWt6ankifQ.h5j64FxBh_zi9G3IdAGpZQ'; // Замените на ваш токен

    // Инициализация карты
    const map = new mapboxgl.Map({
        container: 'map',
        style: 'mapbox://styles/mapbox/streets-v12',
        center: [76.9457, 43.2389], // Центр Алматы
        zoom: 11
    });

    // Данные об опасных зонах (приблизительные координаты)
    const dangerZones = [
        { name: 'Грэс', coords: [76.962, 43.279], reason: 'Повышенная конфликтность в районе' },
        { name: 'Турксибский район', coords: [76.990, 43.300], reason: 'Нарушение общественного порядка' },
        { name: 'Шымбулак', coords: [76.977, 43.126], reason: 'Подозрительная активность групп' },
        { name: 'Туздыбастау', coords: [76.880, 43.200], reason: 'Повышенный риск для безопасности граждан' },
        { name: 'Грэс (2)', coords: [76.960, 43.281], reason: 'Риск краж и мелких преступлений' },
        { name: 'Саяхат', coords: [76.940, 43.260], reason: 'Частые случаи краж личных вещей' },
        { name: 'Пятилетка', coords: [76.910, 43.240], reason: 'Нарушение общественного порядка' },
        { name: 'Микрорайон Жетысу', coords: [76.920, 43.230], reason: 'Риск нападений и краж' }
    ];

    // Добавление маркеров опасных зон
    dangerZones.forEach(zone => {
        const el = document.createElement('div');
        el.className = 'marker';

        new mapboxgl.Marker(el)
            .setLngLat(zone.coords)
            .setPopup(new mapboxgl.Popup({ offset: 25 })
                .setHTML(<h3>${zone.name}</h3><p>${zone.reason}</p>))
            .addTo(map);
    });

    // Инициализация Mapbox Directions
    const directions = new MapboxDirections({
        accessToken: mapboxgl.accessToken,
        unit: 'metric',
        profile: 'mapbox/walking', // Используем пешеходный маршрут
        controls: {
            inputs: true, // Включаем поля ввода для поиска
            instructions: true
        },
        // Исключение опасных зон
        exclude: dangerZones.map(zone => ({
            type: 'point',
            coordinates: zone.coords,
            radius: 0.5 // Радиус исключения в километрах (500 м)
        }))
    });

    // Добавление Directions в карту
    map.addControl(directions, 'top-left');

    // Добавление текущего местоположения
    map.addControl(new mapboxgl.GeolocateControl({
        positionOptions: { enableHighAccuracy: true },
        trackUserLocation: true
    }));

    // Обработка загрузки карты
    map.on('load', () => {
        // Добавление буферных зон (визуализация)
        map.addSource('danger-zones', {
            type: 'geojson',
            data: {
                type: 'FeatureCollection',
                features: dangerZones.map(zone => ({
                    type: 'Feature',
                    geometry: {
                        type: 'Point',
                        coordinates: zone.coords
                    },
                    properties: {
                        radius: 500 // Радиус в метрах
                    }
                }))
            }
        });

        map.addLayer({
            id: 'danger-zones-circles',
            type: 'circle',
            source: 'danger-zones',
            paint: {
                'circle-radius': ['get', 'radius'],
                'circle-color': 'rgba(255, 0, 0, 0.2)',
                'circle-stroke-color': '#ff0000',
                'circle-stroke-width': 1
            }
        });
    });
</script>

</body>
</html>